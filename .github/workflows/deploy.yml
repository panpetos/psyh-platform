name: üöÄ Deploy Vite front to REG.RU

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install dependencies
        run: npm ci || npm i

      # 4. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      - name: Build project
        run: npm run build

      # 5. –î–æ–±–∞–≤–ª—è–µ–º .htaccess –≤ dist (–¥–ª—è SPA –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫—ç—à–∞)
      - name: Add .htaccess to dist
        run: |
          cat > dist/.htaccess << 'EOF'
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
          </IfModule>

          # SPA fallback
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]

          # Disable cache for html
          <IfModule mod_headers.c>
            <FilesMatch "\.html$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
              Header set Pragma "no-cache"
              Header set Expires "0"
            </FilesMatch>
          </IfModule>
          EOF

      # 6. –ó–∞–ª–∏–≤–∞–µ–º –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ REG.RU —á–µ—Ä–µ–∑ FTP
      - name: Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          local-dir: ./dist/               # –ü–∞–ø–∫–∞ —Å —Å–æ–±—Ä–∞–Ω–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º
          server-dir: ./                   # –ö–æ—Ä–µ–Ω—å FTP-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–Ω–µ /www/www)
          dangerous-clean-slate: true      # –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
          log-level: verbose               # –ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/*.map
            api/config.php         # <‚Äî –Ω–µ –∑–∞–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–ø–æ
