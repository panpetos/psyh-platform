name: üöÄ Deploy Vite front to REG.RU

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-front
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) –ë–µ—Ä—ë–º –∫–æ–¥
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2) Node + cache
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3) –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install deps
        run: npm ci || npm i

      # 4) –°–±–æ—Ä–∫–∞ Vite
      - name: Build
        run: npm run build

      # 5) –ö–ª–∞–¥—ë–º .htaccess –≤ dist (SPA + –∫—ç—à)
      - name: Add .htaccess to dist
        run: |
          cat > dist/.htaccess << 'EOF'
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
          </IfModule>

          # SPA fallback
          RewriteEngine On
          RewriteBase /
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]

          # Disable cache for html
          <IfModule mod_headers.c>
            <FilesMatch "\.html$">
              Header set Cache-Control "no-cache, no-store, must-revalidate"
              Header set Pragma "no-cache"
              Header set Expires "0"
            </FilesMatch>
          </IfModule>
          EOF

      # 6) –î–µ–ø–ª–æ–π –¢–û–õ–¨–ö–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ dist –Ω–∞ –∫–æ—Ä–µ–Ω—å –ø–∞–ø–∫–∏ –¥–æ–º–µ–Ω–∞
      - name: Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}

          # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–±–æ—Ä–∫—É
          local-dir: dist/

          # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–æ–º–µ–Ω–∞ –Ω–∞ REG.RU
          # (–∑–∞–º–µ–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞ —Å–≤–æ–π)
          server-dir: /www/psyh.vakulskiy.team/

          # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ª–∏–≤–∫–æ–π.
          # 'exclude' –Ω–∏–∂–µ –∑–∞—â–∏—Ç–∏—Ç /api –∏ –¥—Ä—É–≥–∏–µ –Ω—É–∂–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è.
          dangerous-clean-slate: true

          log-level: verbose

          # –í–ê–ñ–ù–û: –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∏ –∫ –∑–∞–≥—Ä—É–∑–∫–µ, –∏ –∫ —É–¥–∞–ª–µ–Ω–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
          exclude: |
            **/api/**
            api/**
            **/.git*
            **/.github/**
            **/node_modules/**
            **/*.map
            # –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ "www" ‚Äî
            # —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ —É–µ—Ö–∞–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            www/**
